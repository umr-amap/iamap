name: CI/CD Pipeline

on:
  push:
    branches:
      - ga-windows
  pull_request:
    branches:
      - main, dev

jobs:
  build:
    name: ${{ matrix.os }}, Python 3.${{ matrix.python-minor-version }}, QGIS 3.${{ matrix.qgis-minor-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        ## Windows automatic testing is not functionnig yet
        # os: [ubuntu-latest , macos-latest]
        os: [windows-latest]
        # python-minor-version: [11, 12]
        python-minor-version: [12]
        # qgis-minor-version: [34, 38, 40]
        qgis-minor-version: [38]
          
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # - name: Set up Miniconda
    #   uses: conda-incubator/setup-miniconda@v3
    # - name: Set up micromamba
    #   uses: mamba-org/setup-micromamba@v2
    #         init-shell: >-
    #   bash
    #   powershell
    # cache-environment: true
    # post-cleanup: 'all'
    - uses: mamba-org/setup-micromamba@v2
      with:
        # environment-file: environment.yml
        init-shell: >-
          bash
          powershell
        # cache-environment: true
        # post-cleanup: 'all'

      # with:
      #   python-version: 3.${{ matrix.python-minor-version }}
      #   channels: conda-forge, nodefaults
      #   auto-update-conda: true

    - name: Set up Environment and Install Dependencies
      run: |
        mamba create -n pytest python=3.${{ matrix.python-minor-version }} qgis=3.${{ matrix.qgis-minor-version }} --yes
        mamba install -n pytest --file requirements.txt --yes
        mamba install -n pytest pytest --yes
      shell: bash -el {0}

    - name: Run Tests
      run: |
        mamaba run -n pytest pytest tests/
      shell: bash -el {0}
